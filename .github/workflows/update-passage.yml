name: Update Passage Dependency

on:
  repository_dispatch:
    types: [passage-release]
  workflow_dispatch:
    inputs:
      version:
        description: 'Passage version to update to'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write

concurrency:
  group: update-passage
  cancel-in-progress: false

jobs:
  update-dependency:
    runs-on: macos-26
    outputs:
      pr-number: ${{ steps.create-pr.outputs.pr-number }}
      branch-name: ${{ steps.create-branch.outputs.branch-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.2'

      - name: Extract version
        id: get-version
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            VERSION="${{ github.event.client_payload.version }}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Updating to passage version: $VERSION"

      - name: Validate version format
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          if ! echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
            echo "Error: Invalid version format. Expected semver (x.y.z), got: $VERSION"
            exit 1
          fi

      - name: Check if branch already exists
        id: check-branch
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          BRANCH_NAME="feat/update-passage-${VERSION}"
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists. Skipping update."
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create branch
        id: create-branch
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          BRANCH_NAME="feat/update-passage-${VERSION}"
          git checkout -b "$BRANCH_NAME"
          echo "branch-name=$BRANCH_NAME" >> $GITHUB_OUTPUT

      - name: Update Package.swift
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          # Update the passage dependency version
          sed -i '' "s|\(\.package(url: \"https://github.com/rozd/passage.git\", from: \"\)[^\"]*\"|\1${VERSION}\"|" Package.swift
          echo "Updated Package.swift:"
          grep -n "passage.git" Package.swift

      - name: Update Package.resolved
        if: steps.check-branch.outputs.exists != 'true'
        run: swift package update

      - name: Commit changes
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Package.swift Package.resolved
          git commit -m "chore: update passage dependency to ${VERSION}"

      - name: Push branch
        if: steps.check-branch.outputs.exists != 'true'
        run: |
          BRANCH_NAME="${{ steps.create-branch.outputs.branch-name }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        id: create-pr
        if: steps.check-branch.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.get-version.outputs.version }}"
          PR_URL=$(gh pr create \
            --title "chore: update passage to ${VERSION}" \
            --body "## Summary
          - Updates passage dependency to version ${VERSION}
          - Updates Package.resolved

          ## Triggered by
          Upstream passage release: ${VERSION}

          ---
          *This PR was automatically generated by the update-passage workflow.*" \
            --head "${{ steps.create-branch.outputs.branch-name }}" \
            --base main)
          PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
          echo "pr-number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "pr-url=$PR_URL" >> $GITHUB_OUTPUT
          echo "Created PR #$PR_NUMBER: $PR_URL"

  trigger-release:
    needs: update-dependency
    if: needs.update-dependency.outputs.pr-number != ''
    uses: ./.github/workflows/release.yml
    with:
      ref: ${{ needs.update-dependency.outputs.branch-name }}
      pr-number: ${{ needs.update-dependency.outputs.pr-number }}
    secrets: inherit
