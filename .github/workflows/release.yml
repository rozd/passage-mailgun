name: Release

on:
  push:
    branches:
      - '*'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref to build'
        required: false
        type: string
        default: ''
  workflow_call:
    inputs:
      ref:
        description: 'Git ref to build'
        required: false
        type: string
        default: ''
      pr-number:
        description: 'PR number for auto-merge'
        required: false
        type: string
        default: ''

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: ${{ github.workflow }}-${{ inputs.ref || github.ref }}
  cancel-in-progress: true

jobs:
  build-and-test:
    runs-on: macos-26
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2

      - name: Cache Swift packages
        uses: actions/cache@v4
        with:
          path: .build
          key: ${{ runner.os }}-swift-${{ hashFiles('Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-swift-

      - name: Build
        run: swift build -c release

      - name: Test
        run: swift test

  determine-version:
    runs-on: ubuntu-latest
    needs: build-and-test
    outputs:
      version: ${{ steps.get-version.outputs.version }}
      is-main: ${{ steps.check-branch.outputs.is-main }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
          fetch-depth: 0

      - name: Check if main branch
        id: check-branch
        run: |
          REF="${{ inputs.ref || github.ref }}"
          if [[ "$REF" == "refs/heads/main" || "$REF" == "refs/heads/master" || "$REF" == "main" || "$REF" == "master" ]]; then
            echo "is-main=true" >> $GITHUB_OUTPUT
          else
            echo "is-main=false" >> $GITHUB_OUTPUT
          fi

      - name: Get version from tags
        id: get-version
        run: |
          # Get latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          LATEST_TAG="${LATEST_TAG#v}"  # Remove 'v' prefix if present

          echo "Latest tag: $LATEST_TAG"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LATEST_TAG"

          # Increment patch version for new releases
          NEW_PATCH=$((PATCH + 1))
          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"

          echo "New version: $NEW_VERSION"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

  create-archive:
    runs-on: macos-15
    needs: [build-and-test, determine-version]
    outputs:
      archive-name: ${{ steps.archive.outputs.archive-name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}

      - name: Setup Swift
        uses: swift-actions/setup-swift@v2
        with:
          swift-version: '6.0'

      - name: Build release
        run: swift build -c release

      - name: Create archive
        id: archive
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          IS_MAIN="${{ needs.determine-version.outputs.is-main }}"

          if [ "$IS_MAIN" = "true" ]; then
            ARCHIVE_NAME="passage-mailgun-${VERSION}.zip"
          else
            BRANCH_NAME=$(echo "${{ inputs.ref || github.ref }}" | sed 's|refs/heads/||' | sed 's|/|-|g')
            SHORT_SHA=$(git rev-parse --short HEAD)
            ARCHIVE_NAME="passage-mailgun-${VERSION}-${BRANCH_NAME}-${SHORT_SHA}.zip"
          fi

          # Create archive from build artifacts
          cd .build/release
          zip -r "../../${ARCHIVE_NAME}" . -x "*.build/*" -x "*.dSYM/*" -x "ModuleCache/*" -x "*.swiftmodule/*"
          cd ../..

          echo "archive-name=$ARCHIVE_NAME" >> $GITHUB_OUTPUT
          echo "Created archive: $ARCHIVE_NAME"

      - name: Upload archive artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-archive
          path: ${{ steps.archive.outputs.archive-name }}

  intermediate-release:
    runs-on: ubuntu-latest
    needs: [create-archive, determine-version]
    if: needs.determine-version.outputs.is-main == 'false'
    steps:
      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: release-archive

      - name: List artifacts
        run: |
          echo "Intermediate release artifact:"
          ls -la

  auto-merge:
    runs-on: ubuntu-latest
    needs: intermediate-release
    if: inputs.pr-number != ''
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Enabling auto-merge for PR #${{ inputs.pr-number }}"
          gh pr merge ${{ inputs.pr-number }} --auto --squash --delete-branch

  public-release:
    runs-on: ubuntu-latest
    needs: [create-archive, determine-version]
    if: needs.determine-version.outputs.is-main == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download archive
        uses: actions/download-artifact@v4
        with:
          name: release-archive

      - name: Create and push tag
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          ARCHIVE_NAME="${{ needs.create-archive.outputs.archive-name }}"

          gh release create "${VERSION}" \
            --title "Release ${VERSION}" \
            --generate-notes \
            "${ARCHIVE_NAME}"
